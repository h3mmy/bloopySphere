---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app bloopyboi
  namespace: default
  labels:
    component.bloopysphere-0/aspect: automata
spec:
  interval: 60m
  chart:
    spec:
      chart: app-template
      version: 4.4.0
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  install:
    remediation:
      retries: 4
  upgrade:
    cleanupOnFail: true
    remediation:
      remediateLastFailure: true
  driftDetection:
    mode: enabled
    ignore:
      - paths: ["/spec/replicas"]
  values:
    controllers:
      bloopyboi:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          app:
            image:
              repository: ghcr.io/h3mmy/bloopyboi
              tag: dev@sha256:4bfe63d5da7ca507354ad3bc92baf79758eac87ce6ff8f798a29b11c3050c81a
            env:
              TZ: ${TZ}
              GOOGLE_APPLICATION_CREDENTIALS: &svc-keyfile /bloopy-ops-dev.json
              # Downward API stuff.
              # - name: NODE_NAME
              #   valueFrom:
              #     fieldRef:
              #       fieldPath: spec.nodeName
              # - name: POD_NAME
              #   valueFrom:
              #     fieldRef:
              #       fieldPath: metadata.name
              # - name: POD_NAMESPACE
              #   valueFrom:
              #     fieldRef:
              #       fieldPath: metadata.namespace
              # - name: POD_IP
              #   valueFrom:
              #     fieldRef:
              #       fieldPath: status.podIP
              # - name: POD_SERVICE_ACCOUNT
              #   valueFrom:
              #     fieldRef:
              #       fieldPath: spec.serviceAccountName
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 100
        fsGroup: 100
        fsGroupChangePolicy: OnRootMismatch

    service:
      app:
        controller: *app
        primary: true
        # externalTrafficPolicy: Local
        ports:
          health:
            port: 3000
          http:
            port: &port 8080

    route:
      app:
        hostnames: ["{{ .Release.Name }}.${XYZ_DOMAIN}"]
        parentRefs:
          - name: traefik
            namespace: networking
            sectionName: websecure
        rules:
          - backendRefs:
              - name: *app
                port: *port
            matches:
              - path:
                  type: PathPrefix
                  value: /discord/linked-roles
              - path:
                  type: PathPrefix
                  value: /discord/linked-roles/callback
            filters:
              - type: ExtensionRef
                extensionRef:
                  group: traefik.io
                  kind: Middleware
                  name: chain-no-auth
          - backendRefs:
              - name: *app
                port: *port
            matches:
              - path:
                  type: PathPrefix
                  value: /
            filters:
              - type: ExtensionRef
                extensionRef:
                  group: traefik.io
                  kind: Middleware
                  name: bloopnet-xyz-auth
    persistence:
      config:
        enabled: true
        type: configMap
        name: bloopyboi-config
        globalMounts:
          - path: /config
            readOnly: true
      svckeyfile:
        enabled: true
        type: secret
        name: bloopyboi-app-keys
        globalMounts:
          - path: *svc-keyfile
            subPath: bloopy-ops-dev.json
