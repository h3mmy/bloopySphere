---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: emqx-exporter
  namespace: home
spec:
  interval: 5m
  chart:
    spec:
      chart: kah-common-chart
      version: 4.4.1
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home-charts
        namespace: flux-system
      interval: 5m
  dependsOn:
    - name: emqx
      namespace: home
  values:
    image:
      repository: nuvo/emq_exporter
      tag: v0.5.1
    controller:
      replicas: 1
    nameOverride: emqx-exporter
    env:
      EMQ_USERNAME: ${EMQX_METRICS_USER}
      EMQ_PASSWORD: ${EMQX_METRICS_PASSWORD}
    args:
      - --emq.api-version=v4
      - --emq.node="http://emqx:8081"
    tolerations:
      - key: "arch"
        operator: "Equal"
        value: "arm64"
        effect: "NoSchedule"
    service:
      main:
        ports:
          http:
            enabled: false
          metrics:
            enabled: true
            protocol: TCP
            port: 9540
    metrics:
      enabled: true
      serviceMonitor:
        interval: 3m
        scrapeTimeout: 1m
      prometheusRule:
        enabled: false
