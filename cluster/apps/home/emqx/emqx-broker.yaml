---
apiVersion: apps.emqx.io/v1beta2
kind: EmqxBroker
metadata:
  name: emqx
  namespace: home
spec:
  serviceAccountName: "emqx"
  image: emqx/emqx:4.4.4
  replicas: 2
  labels:
    cluster: emqx
    app.kubernetes.io/name: emqx
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - emqx
            topologyKey: kubernetes.io/hostname

  env:
    - name: EMQX_PROMETHEUS__PUSH__GATEWAY__SERVER
      value: prometheus-pushgateway.monitoring:9091
    - name: EMQX_ADMIN_PASSWORD
      value: ${EMQX_ADMIN_PASSWORD}
    - name: EMQX_AUTH__USER__1__USERNAME
      value: ${EMQX_USER_1_USERNAME}
    - name: EMQX_AUTH__USER__1__PASSWORD
      value: ${EMQX_USER_1_PASSWORD}
    - name: EMQX_AUTH__USER__2__USERNAME
      value: ${EMQX_USER_2_USERNAME}
    - name: EMQX_AUTH__USER__2__PASSWORD
      value: ${EMQX_USER_2_PASSWORD}
    - name: EMQX_AUTH__USER__3__USERNAME
      value: ${EMQX_USER_3_USERNAME}
    - name: EMQX_AUTH__USER__3__PASSWORD
      value: ${EMQX_USER_3_PASSWORD}
    - name: EMQX_AUTH__USER__4__USERNAME
      value: ${EMQX_USER_4_USERNAME}
    - name: EMQX_AUTH__USER__4__PASSWORD
      value: ${EMQX_USER_4_PASSWORD}
    - name: EMQX_AUTH__USER__5__PASSWORD
      value: ${EMQX_USER_5_PASSWORD}
    - name: EMQX_AUTH__USER__5__USERNAME
      value: ${EMQX_USER_5_USERNAME}
    - name: EMQX_AUTH__USER__6__USERNAME
      value: ${EMQX_METRICS_USER}
    - name: EMQX_AUTH__USER__6__PASSWORD
      value: ${EMQX_METRICS_PASSWORD}
    # - name: EMQX_AUTH__LDAP__SERVERS
    #   value: ak-outpost-ldap-outpost.auth.svc.cluster.local
    # - name: EMQX_AUTH__LDAP__PORT
    #   value: "389"
    # - name: EMQX_AUTH__LDAP__BIND_DN
    #   value: ${EMQX_BIND_DN}
    # - name: EMQX_AUTH__LDAP__BIND_PASSWORD
    #   value: ${EMQX_BIND_PASSWORD}
    # - name: EMQX_AUTH__LDAP__TIMEOUT
    #   value: 30s
    # - name: EMQX_AUTH__LDAP__DEVICE_DN
    #   value:
    # - name: EMQX_AUTH__LDAP__MATCH_OBJECTCLASS
    #   value: user
    # - name: EMQX_AUTH__LDAP__USERNAME__ATTRIBUTETYPE
    #   value: cn
    # - name: EMQX_AUTH__LDAP__PASSWORD__ATTRIBUTETYPE
    #   value: password


  emqxTemplate:
    listener:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-production
      type: ClusterIP
      ports:
        mqtt: 1883
        mqtts: 8883
        ws: 8083
        wss: 8084
        dashboard: 18083
        api: 8081
    acl:
      # v1beta2 -> v1beta3 screwed this up and also the kustomization won't reconcile due to creationTimestamp being a non-field
      # - '{allow, {user, "dashboard"}, subscribe, ["$SYS/#"]}.'
      # - '{allow, {ipaddr, "127.0.0.1"}, pubsub, ["$SYS/#", "#"]}.'
      # - '{deny, all, subscribe, ["$SYS/#", {eq, "#"}]}.'
      # - '{allow, all}.'
      - permission: allow
        username: "dashboard"
        action: subscribe
        topics:
          filter:
            - "$SYS/#"
            - "#"
      - permission: allow
        ipaddress: "127.0.0.1"
        topics:
          filter:
            - "$SYS/#"
          equal:
            - "#"
      - permission: deny
        action: subscribe
        topics:
          filter:
            - "$SYS/#"
          equal:
            - "#"
      - permission: allow
    plugins:
      - name: emqx_management
        enable: true
      - name: emqx_recon
        enable: true
      - name: emqx_retainer
        enable: true
      - name: emqx_dashboard
        enable: true
      - name: emqx_telemetry
        enable: false
      - name: emqx_rule_engine
        enable: true
      - name: emqx_bridge_mqtt
        enable: false
      - name: emqx_prometheus
        enable: true
      - name: emqx_auth_mnesia
        enable: true
    modules:
      - name: emqx_mod_acl_internal
        enable: true
      - name: emqx_mod_presence
        enable: true
      - name: emqx_mod_rewrite
        enable: false
      - name: emqx_mod_delayed
        enable: false
      - name: emqx_mod_topic_metrics
        enable: true
      - name: emqx_mod_subscription
        enable: true
